require 'open-uri'
require 'net/http'
require 'json'
require 'base64'

# 实现 github 官方给出的 api 接口
def public_send(method,file_path:'',git_path:nil,body:{},msg:nil)
  git_path=git_path||"default/#{File.basename(file_path)}"
  url=URI("https://api.github.com/repos/liangxiongsl/image-repo/contents/#{git_path}")

  case method
  when 'get'
    req=Net::HTTP::Get.new(url)
    req['Authorization']='token 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'
  when 'put'
    req=Net::HTTP::Put.new(url)
    req['Authorization']='token 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'
    req.body={
      'message':msg||'upload file',
      'content':Base64.encode64(File.read(file_path))
    }.to_json
  when 'delete'
    req=Net::HTTP::Delete.new(url)
    req['Authorization']='token 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'
    req.body={
      'message':msg||'delete file',
      'sha':JSON.parse(public_send('get',file_path:file_path,git_path:git_path))['sha']
    }.to_json
  end

  Net::HTTP.start(url.hostname,url.port,use_ssl: true ) do |http|
    http.request(req)
  end.body
end

require 'clipboard'

File.open('tmp.txt','w') do |f|
  clip=Clipboard.paste
  f.write clip.encode("UTF-8")
end

public_send('put',file_path:'tmp.txt',git_path:"txt/#{Time.now.strftime("%Y%m%d_%H%M%S")}.txt")
